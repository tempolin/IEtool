<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>イナズマキャラ図鑑 & 編成ツール</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f4f4f4;
  margin: 20px;
}
.panel {
  background: #fff;
  padding: 16px;
  margin-bottom: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
h1 { margin-bottom: 10px; }
label { font-size: 0.9rem; margin-right: 4px; }

/* 表 */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
}
th {
  background: #eaeaea;
}
.char-img {
  width: 45px;
  height: 45px;
  object-fit: cover;
}

/* ピッチ UI */
.pitch-wrapper {
  display: flex;
  justify-content: center;
}
.pitch {
  width: 600px;
  aspect-ratio: 3 / 4;
  background: #4caf50;
  border-radius: 20px;
  padding: 10px;
  display: grid;
  grid-template-rows: repeat(4, 1fr);
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  position: relative;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
.slot {
  border: 2px dashed rgba(255,255,255,0.7);
  background: rgba(0,0,0,0.35);
  border-radius: 10px;
  padding: 4px;
  color: #fff;
  font-size: 0.8rem;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.slot label {
  font-weight: bold;
  color: #ffeb3b;
}
.slot select {
  font-size: 0.8rem;
  width: 100%;
}
.row-title {
  position: absolute;
  left: 10px;
  font-size: 0.9rem;
  color: #fff;
  text-shadow: 0 0 4px rgba(0,0,0,0.8);
}
.row-title.fw { top: 5px; }
.row-title.mf { top: 25%; }
.row-title.df { top: 50%; }
.row-title.gk { bottom: 5px; }
</style>
</head>

<body>

<h1>イナズマキャラ図鑑 & 編成ツール</h1>

<!-- ======== 図鑑機能 ======== -->
<div class="panel">
<h2>キャラ検索</h2>

<label>名前：</label>
<input type="text" id="nameFilter">
<label>属性：</label>
<select id="attributeFilter"><option value="">すべて</option></select>
<label>ポジション：</label>
<select id="positionFilter"><option value="">すべて</option></select>
<label>チーム：</label>
<select id="teamFilter"><option value="">すべて</option></select>
<label>ビルド：</label>
<select id="buildFilter"><option value="">すべて</option></select>

<button id="searchBtn">検索</button>
<button id="resetBtn">リセット</button>

<table>
<thead>
<tr>
  <th>名前</th>
  <th>属性</th>
  <th>ポジション</th>
  <th>チーム</th>
  <th>ビルドタイプ</th>
  <th>画像</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<!-- ======== 編成 UI ======== -->
<div class="panel">
<h2>編成（4-4-2）</h2>

<div class="pitch-wrapper">
<div class="pitch">

<span class="row-title fw">FW</span>
<span class="row-title mf">MF</span>
span class="row-title df">DF</span>
<span class="row-title gk">GK</span>

<!-- FW -->
<div class="slot" style="grid-row:1; grid-column:2;">
  <label>FW1</label>
  <select data-position="FW" id="FW1"></select>
</div>
<div class="slot" style="grid-row:1; grid-column:3;">
  <label>FW2</label>
  <select data-position="FW" id="FW2"></select>
</div>

<!-- MF -->
<div class="slot" style="grid-row:2; grid-column:1;">
  <label>MF1</label>
  <select data-position="MF" id="MF1"></select>
</div>
<div class="slot" style="grid-row:2; grid-column:2;">
  <label>MF2</label>
  <select data-position="MF" id="MF2"></select>
</div>
<div class="slot" style="grid-row:2; grid-column:3;">
  <label>MF3</label>
  <select data-position="MF" id="MF3"></select>
</div>
<div class="slot" style="grid-row:2; grid-column:4;">
  <label>MF4</label>
  <select data-position="MF" id="MF4"></select>
</div>

<!-- DF -->
<div class="slot" style="grid-row:3; grid-column:1;">
  <label>DF1</label>
  <select data-position="DF" id="DF1"></select>
</div>
<div class="slot" style="grid-row:3; grid-column:2;">
  <label>DF2</label>
  <select data-position="DF" id="DF2"></select>
</div>
<div class="slot" style="grid-row:3; grid-column:3;">
  <label>DF3</label>
  <select data-position="DF" id="DF3"></select>
</div>
<div class="slot" style="grid-row:3; grid-column:4;">
  <label>DF4</label>
  <select data-position="DF" id="DF4"></select>
</div>

<!-- GK -->
<div class="slot" style="grid-row:4; grid-column:2 / span 2;">
  <label>GK</label>
  <select data-position="GK" id="GK"></select>
</div>

</div>
</div>

<button id="downloadFormation">編成CSVダウンロード</button>
</div>

<script>
// ======== CSV 読み込み ========
let allChars = [];

async function loadCSV() {
  const res = await fetch("characters.csv");
  const text = await res.text();
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");

  allChars = lines.slice(1).map(line => {
    const cols = line.split(",");
    let obj = {};
    headers.forEach((h, i) => obj[h] = cols[i] ?? "");
    return obj;
  });

  initFilters();
  updateTable(allChars);
  initFormationOptions();
}

function initFilters() {
  fillSelect("attributeFilter", "attribute");
  fillSelect("positionFilter", "position");
  fillSelect("teamFilter", "team");
  fillSelect("buildFilter", "build_type");
}

function fillSelect(id, key) {
  const sel = document.getElementById(id);
  const values = [...new Set(allChars.map(c => c[key]).filter(v => v))];
  values.forEach(v => {
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    sel.appendChild(op);
  });
}

// ======== 検索処理 ========
document.getElementById("searchBtn").onclick = () => {
  const name = document.getElementById("nameFilter").value;
  const attribute = document.getElementById("attributeFilter").value;
  const position = document.getElementById("positionFilter").value;
  const team = document.getElementById("teamFilter").value;
  const build = document.getElementById("buildFilter").value;

  let filtered = allChars.filter(c => {
    return (!name || c.name.includes(name)) &&
           (!attribute || c.attribute === attribute) &&
           (!position || c.position === position) &&
           (!team || c.team === team) &&
           (!build || c.build_type === build);
  });

  updateTable(filtered);
};

document.getElementById("resetBtn").onclick = () => {
  document.getElementById("nameFilter").value = "";
  ["attributeFilter","positionFilter","teamFilter","buildFilter"]
    .forEach(id => document.getElementById(id).value = "");
  updateTable(allChars);
};

// ======== 表を描画 ========
function updateTable(list) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  list.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.name}</td>
      <td>${c.attribute}</td>
      <td>${c.position}</td>
      <td>${c.team}</td>
      <td>${c.build_type}</td>
      <td><img class="char-img" src="${c.image_url}"></td>
    `;
    tbody.appendChild(tr);
  });
}

// ======== 編成スロットに候補を入れる ========
function initFormationOptions() {
  document.querySelectorAll("select[data-position]").forEach(sel => {
    const pos = sel.dataset.position;
    const candidates = allChars.filter(c => c.position === pos);

    sel.innerHTML = `<option value="">（空）</option>`;
    candidates.forEach(c => {
      const op = document.createElement("option");
      op.value = c.name;
      op.textContent = c.name;
      sel.appendChild(op);
    });
  });
}

// ======== CSV ダウンロード ========
document.getElementById("downloadFormation").onclick = () => {
  let rows = [["slot","name"]];
  document.querySelectorAll("select[data-position]").forEach(sel => {
    rows.push([sel.id, sel.value]);
  });
  let csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "formation.csv";
  a.click();
};

loadCSV();
</script>

</body>
</html>
